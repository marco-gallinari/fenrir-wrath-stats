<!DOCTYPE html>
<html>
  <head>
    <title>Fenrir Wrath</title>
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:300,600,400" rel="stylesheet" type="text/css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css" type="text/css" rel="stylesheet">
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/themes/2.0.0/sea.min.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
     
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
    
    <style type="text/css">

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            color: #262626;
            font-family: "Helvetica Neue Light","Open Sans",Helvetica;
            font-size: 14px;
            display: flex;
            flex-direction: column;
        }

        .loader {
            position: fixed;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
            z-index: 1000;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #row1 {
            flex: 1;
            margin-top: 45px;
            display: flex;
            flex-direction: row;
            min-height: 800px;
        }

        #row2 {
            flex: 1;
            display: flex;
            flex-direction: row;
            min-height: 600px;
        }

        #pie {
            flex: 1;
            width:400px;
            margin: 0;
            padding: 0;
        }

        #bars {
            flex: 1;
        }

        #table {
            width: 100%;
            min-height: 600px;
            margin: 0;
            padding: 0;
        }

        /* Style the tab */
        .tab {
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        /* Style the buttons that are used to open the tab content */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        .hidden {
            visibility: hidden;
        }
      
    </style>
  </head>
  <body>

    <div class="tab">
        <button class="tablinks" onclick="openWar(event, 1893)">War 21/9/2020</button>
        <button class="tablinks" onclick="openWar(event, 1879)">War 3/10/2020</button>
    </div>

    <div class="loader hidden"></div>
    
    <div id="row1">
        <div id="pie"></div>  
        <div id="bars"></div>   
    </div>
    <div id="row2">    
        <div id="table"></div>  
    </div>
                                    
    <script>
        var chart, bchart;
        function disposeCharts() {
            if (chart) chart.dispose();
            if (bchart) bchart.dispose();
            $("#table").empty();
        }

        function percentile(arr, p) {
            if (arr.length === 0) return 0;
            if (typeof p !== 'number') throw new TypeError('p must be a number');
            if (p <= 0) return arr[0];
            if (p >= 1) return arr[arr.length - 1];

            arr.sort(function (a, b) { return a - b; });
            var index = (arr.length - 1) * p
                lower = Math.floor(index),
                upper = lower + 1,
                weight = index % 1;

            if (upper >= arr.length) return arr[lower];
            return arr[lower] * (1 - weight) + arr[upper] * weight;
        }

        function perc2color(perc,min,max) {
            var base = (max - min);

            if (base == 0) { perc = 100; }
            else {
                perc = (perc - min) / base * 100; 
            }
            var r, g, b = 0;
            if (perc < 50) {
                r = 255;
                g = Math.round(5.1 * perc);
            }
            else {
                g = 255;
                r = Math.round(510 - 5.10 * perc);
            }
            var h = r * 0x10000 + g * 0x100 + b * 0x1;
            return '#' + ('000000' + h.toString(16)).slice(-6);
        }

        function percentileTemplate(value, percentile, mins, maxs, field) {
            return $("<div>")
            .attr("style", `width:100%;height:100%;padding-right:5px;border-radius:3px;background-color:${perc2color(value - percentile, mins[field], maxs[field])};filter: brightness(90%) opacity(80%);`)
            .text(value);
        } 

        function openWar(event, source) {    
            disposeCharts(); 
            anychart.theme(anychart.themes.sea);

            $(".loader").removeClass("hidden");

            $(".tablinks").removeClass("active");
            $(event.currentTarget).addClass("active");

            // Fetch Data from the API
            fetch(`https://api.apispreadsheets.com/data/${source}/?dataFormat=matrix`)
                .then((response) => {
                    return response.json();
            })
            .then((myJson) => {
                
            // create data variable for the chart
                var data = [];
                var totMana = 0.0;
                var cris = [];
                var totCri1 = 0.0;
                var totCri2 = 0.0;

                for (var i = 1; i < 30; i++) {
                    if (myJson.data[i][1].length > 0) {
                        var mana = +(myJson.data[i][2].replace(/,/,'.'));
                        var c1 = +(myJson.data[i][3].replace(/,/,'.'));
                        var c2 = +(myJson.data[i][4].replace(/,/,'.'));
                        totMana += mana;
                        totCri1 += c1;
                        totCri2 += c2;
                        data.push({ x: myJson.data[i][1], value: mana });
                        cris.push({ player: myJson.data[i][1], cri1: c1, cri2: c2, tc: c1 + c2 });
                    }
                }
                var avg = +(myJson.data[0][2].replace(/,/,'.'));

                data = data.sort(function(a, b) {
                  return b.value - a.value;
                });
                cris = cris.sort(function(a, b) {
                  return b.tc - a.tc;
                });

                chart = anychart.pie(data);

                chart.palette(anychart.palettes.sea);
                chart.innerRadius("50%");
                chart.title("Mana collected");
                //enables HTML tags
                chart.title().text(
                    "<b>Mana collected <i>(M)</i></b>" +
                    `<br><p style="font-size:12px">Total: ${totMana.toFixed(1)}M<br>Average: ${avg.toFixed(2)}M<p></i>`
                ).useHtml(true);
                chart.labels().position("outside").fontColor("#262626");
                chart.connectorStroke({color: "#595959", thickness: 1, dash:"2 2"});


                chart.container("pie");
                chart.draw();

                // create a chart
                bchart = anychart.bar();
                bchart.palette(anychart.palettes.sea);
                bchart.title("Crystals collected (k)");
                //enables HTML tags
                bchart.title().text(
                    "<b>Crystals collected <i>(k)</i></b>" +
                    `<br><p style="font-size:12px">Type I: ${totCri1.toFixed(1)}M<br>Type II: ${totCri2.toFixed(1)}M<p></i>`
                ).useHtml(true);
                bchart.legend(true);

                // enable the value stacking mode
                bchart.yScale().stackMode("value");

                // create bar series
                var series1 = bchart.bar(cris.map((el) => {
                    return [el.player, el.cri1];
                }));
                var series2 = bchart.bar(cris.map((el) => {
                    return [el.player, el.cri2];
                }));

                series1.name("Crystal I (k)");
                series2.name("Crystal II (k)");

                bchart.container("bars");
                bchart.draw();

                var tableData = $.map(
                        myJson.data.slice(1,31).filter(
                            (v) => {
                                return v[1].length > 1;
                            }),
                        (el, ix) => {
                            return {
                                No : el[0],
                                Player : el[1],
                                ManaCollected : +(el[2].replace(/,/,'.')),
                                CrystalI : +(el[3].replace(/,/,'.')),
                                CrystalII : +(el[4].replace(/,/,'.')),
                                Islands : el[5],
                                DefeatedHeroes : el[6],
                                AVGEnemyPower : el[7],
                                Hardness : +(el[8].replace(/,/,'.')),
                                PlayerPower : el[9]
                            }
                        }).sort(function(a, b) {
                            return b.ManaCollected - a.ManaCollected ;
                        });
                
                var mana60th = percentile($.map(tableData, (el, ix) => {
                    return el.ManaCollected
                }), 0.6);
                
                var cri160th = percentile($.map(tableData, (el, ix) => {
                    return el.CrystalI
                }), 0.6);

                var cri260th = percentile($.map(tableData, (el, ix) => {
                    return el.CrystalII
                }), 0.6);
                
                var islands60th = percentile($.map(tableData, (el, ix) => {
                    return el.Islands
                }), 0.6);
                
                var def60th = percentile($.map(tableData, (el, ix) => {
                    return el.DefeatedHeroes
                }), 0.6);
                
                var avgdef60th = percentile($.map(tableData, (el, ix) => {
                    return el.AVGEnemyPower
                }), 0.6);
                
                var hard60th = percentile($.map(tableData, (el, ix) => {
                    return el.Hardness
                }), 0.6);
                
                var pow60th = percentile($.map(tableData, (el, ix) => {
                    return el.PlayerPower
                }), 0.6);
                
                var min60ths = {
                    mana: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.ManaCollected - mana60th })),
                    cri1: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.CrystalI - cri160th })),
                    cri2: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.CrystalII - cri260th })),
                    isln: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.Islands - islands60th })),
                    defe: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.DefeatedHeroes - def60th })),
                    avgd: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.AVGEnemyPower - avgdef60th })),
                    hard: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.Hardness - hard60th })),
                    powr: Math.min.apply(Math, $.map(tableData, (el, ix) => { return el.PlayerPower - pow60th })),
                }; 
                
                var max60ths = {
                    mana: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.ManaCollected - mana60th })),
                    cri1: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.CrystalI - cri160th })),
                    cri2: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.CrystalII - cri260th })),
                    isln: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.Islands - islands60th })),
                    defe: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.DefeatedHeroes - def60th })),
                    avgd: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.AVGEnemyPower - avgdef60th })),
                    hard: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.Hardness - hard60th })),
                    powr: Math.max.apply(Math, $.map(tableData, (el, ix) => { return el.PlayerPower - pow60th })),
                }; 

                $("#table").jsGrid({
                    width: "100%",
                    height: "1050px",
                    sorting: true,
            
                    data: tableData,

                    fields: [
                        { name: "No", title: "Number", type: "number", width: 30, visible: false },
                        { name: "Player", title: "Player", type: "text", width: 150 },
                        { name: "ManaCollected", title: "Mana (M)", type: "number", 
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, mana60th, min60ths, max60ths, "mana");
                            } 
                        },
                        { name: "CrystalI", title: "Crystal I (k)", type: "number", 
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, cri160th, min60ths, max60ths, "cri1");
                            } 
                        },
                        { name: "CrystalII", title: "Crystal II (k)", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, cri260th, min60ths, max60ths, "cri2");
                            } 
                        },
                        { name: "Islands", title: "Islands captured", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, islands60th, min60ths, max60ths, "isln");
                            } 
                        },
                        { name: "DefeatedHeroes", title: "Defeated Heroes (k)", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, def60th, min60ths, max60ths, "defe");
                            } 
                        },
                        { name: "AVGEnemyPower", title: "Avg Enemy Power (k)", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, avgdef60th, min60ths, max60ths, "avgd");
                            } 
                        },
                        { name: "Hardness", title: "Difficulty", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, hard60th, min60ths, max60ths, "hard");
                            } 
                        },
                        { name: "PlayerPower", title: "Player power (k)", type: "number",
                            itemTemplate: function(value, item) {
                                return percentileTemplate(value, pow60th, min60ths, max60ths, "powr");
                            } 
                        }
                    ]
                });

                $(".loader").addClass("hidden");
            });
        }
      </script>
</body>
</html>
