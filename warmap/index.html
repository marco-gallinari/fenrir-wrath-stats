
<!DOCTYPE html>
<html>
    <head>
        <title>Fenrir Wrath</title>  
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600,400" rel="stylesheet" type="text/css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
        <script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>

        <style type="text/css">
            /* #canvas { 
                width: 100vw;
                height: 100vh;
            } */
        </style>
    </head>
    <body style="margin:0;">
        <canvas  style="margin:0;position:absolute;top:0;" id="toolbar" width="500" height="32"></canvas>
        <canvas  style="margin:0;position:absolute;top:32px;" id="canvas" width="500" height="800"></canvas>
        
        <script>
            var H, W, SCALE, MAPW;
            var clanMap, neighbourMap;
            var stage;

            location.queryString = {};
            location.search.substr(1).split("&").forEach(function (pair) {
                if (pair === "") return;
                var parts = pair.split("=");
                location.queryString[parts[0]] = parts[1] &&
                    decodeURIComponent(parts[1].replace(/\+/g, " "));
            });

            var settings = {
                maps: 5
            }

            var mapSlots = [];

            var mapsLayout = [];

            var TBARH = 45 * window.devicePixelRatio;

            var selectedShield = null;

            var lockScroll = false;

            function resize() {
                H = ($(window).height() - 50);
                $("#canvas").height(H + "px").attr("height", H);
                $("#toolbar").height(TBARH + "px").attr("height", TBARH);
            }
            $(document).ready(function(){
                $("#canvas").css("backgroundColor", "#ff0000");
                $("#canvas").css("top", TBARH + "px");
                resize();
                resize();
                
                // 16 * 8
                for (var x = 0; x < 16; x++) {
                    var mapRow = [];
                    for (var y = 0; y < 8; y++) {
                        if (
                            (x == 0 && y < 6) ||
                            (x == 1 && (y > 0 && y < 5)) ||
                            (x == 2 && (y > 1 && y < 4)) ||
                            (x == 3 && y == 6) ||
                            (x == 4 && (y == 5 || y == 6)) ||
                            ((x == 6 || x == 7) && y == 4) ||
                            (x == 9 && (y == 2 || y == 5 || y == 6)) ||
                            ((x == 11 || x == 12) && (y == 2)) ||
                            (x == 14 && (y == 0 || y == 7))  ||
                            (x == 15 && (y < 2 || y > 5)) 
                            ) {
                            mapRow.push({
                                drawable: false
                            });
                            continue;
                        }
                        if (x == 15 && y == 4) {
                            mapRow.push({
                                drawable: false,
                                citadel: true
                            });
                            continue;
                        }
                        mapRow.push({
                            drawable: true
                        });
                    }
                    mapSlots.push(mapRow);
                }

                setTimeout(() => { 
                    var useXHR = true;
                    if (window.location.href.startsWith("file"))
                        useXHR = false;
                    var queue = new createjs.LoadQueue(useXHR, "", "");
                    
                    queue.on("complete", function(event) {
                        stage = new createjs.Stage("canvas");

                        createjs.Touch.enable( stage, true, true );
                        stage.preventSelection = false;
                        stage.enableMouseOver(100);

                        var clan = queue.getResult("clan");
                        var vicini = queue.getResult("vicini");
                        clanMap = new createjs.Bitmap(clan);
                        neighbourMap = new createjs.Bitmap(vicini);
                        
                        var scudo = queue.getResult("scudo");
                        var divieto = queue.getResult("divieto");
                        var toolbar = new createjs.Stage("toolbar");

                        var emptyShield = new createjs.Bitmap(divieto);
                        emptyShield.scale = Math.floor((TBARH - (5 * window.devicePixelRatio)) / emptyShield.getBounds().height * 100)/100;
                        emptyShield.x = 2;
                        emptyShield.y = 2;
                        var hit = new createjs.Shape();
                        hit.graphics.beginFill("#000").drawRect(0, 0, emptyShield.getBounds().width, emptyShield.getBounds().height).endFill();
                        emptyShield.hitArea = hit;
                        emptyShield.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = 0;
                            toolbar.update();
                            selectedShield = null;
                        }, false);

                        var iconRect = new createjs.Shape();
                        iconRect.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, TBARH, TBARH);

                        var blueShield = new createjs.Bitmap(scudo);
                        blueShield.scale = Math.floor((TBARH - (5 * window.devicePixelRatio)) / blueShield.getBounds().height * 100)/100;
                        blueShield.x = emptyShield.x + TBARH;
                        blueShield.y = 2;
                        blueShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 38,75,150,0)
                        ];
                        blueShield.cache(0, 0, blueShield.getBounds().width, blueShield.getBounds().height);
                        blueShield.hitArea = hit;

                        blueShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = TBARH;
                            toolbar.update();
                            selectedShield = blueShield;
                        }, false);

                        var redShield = blueShield.clone();
                        redShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 191,33,47,0)
                        ];
                        redShield.cache(0, 0, redShield.getBounds().width, redShield.getBounds().height);
                        redShield.x = redShield.x + TBARH;
                        redShield.hitArea = hit;
                        redShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = TBARH * 2;
                            toolbar.update();
                            selectedShield = redShield;
                        }, false);

                        var greenShield = blueShield.clone();
                        greenShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 0,111,60,0)
                        ];
                        greenShield.cache(0, 0, greenShield.getBounds().width, greenShield.getBounds().height);
                        greenShield.x = redShield.x + TBARH;
                        greenShield.hitArea = hit;
                        greenShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = TBARH * 3;
                            toolbar.update();
                            selectedShield = greenShield;
                        }, false);

                        toolbar.addChild(iconRect);
                        toolbar.addChild(emptyShield);
                        toolbar.addChild(blueShield);
                        toolbar.addChild(redShield);
                        toolbar.addChild(greenShield);
                            
                        var shieldc = new createjs.Shape();
                        shieldc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH * 4, TBARH);
                        toolbar.addChild(shieldc);

                        var download = queue.getResult("download");
                        var downloadB = new createjs.Bitmap(download);
                        downloadB.scale = Math.floor(TBARH / downloadB.getBounds().height * 100)/100;
                        downloadB.x = TBARH * 4 + 1;
                        downloadB.hitArea = hit;
                        downloadB.addEventListener('pressup', function(event) {
                            exportJpeg();
                        }, false);
                        toolbar.addChild(downloadB);

                        var downc = new createjs.Shape();
                        downc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        downc.x = downloadB.x;
                        toolbar.addChild(downc);

                        toolbar.update();

                        DrawMap();
                    });

                    queue.loadFile({src:"mappaCLAN.jpg", id:"clan"});
                    queue.loadFile({src:"mappaVICINI.jpg", id:"vicini"});
                    queue.loadFile({src:"shield.png", id:"scudo"});
                    queue.loadFile({src:"forbidden.png", id:"divieto"});
                    queue.loadFile({src:"download.png", id:"download"});

                }, 100);
                
            });

            function DrawMap() {
                SCALE = Math.floor(H / clanMap.getBounds().height * 100)/100;
                MAPW = clanMap.getBounds().width * SCALE;

                W = MAPW * settings.maps;
                $("#canvas").width(W + "px").attr("width", W);

                mapsLayout = [];
                for (var m = 0; m < settings.maps; m++) {
                    var mapLayout = JSON.parse(JSON.stringify(mapSlots));
                    mapsLayout.push(mapLayout);
                }

                var sideMaps = Math.floor(settings.maps / 2);

                clanMap.scale = SCALE;
                clanMap.x = sideMaps * MAPW;

                for (var i = 0; i < sideMaps; i++) {
                    var map1 = neighbourMap.clone();
                    map1.scale = SCALE;
                    map1.x = i * MAPW;
                    stage.addChild(map1);
                }

                stage.addChild(clanMap);
                
                for (var i = 0; i < sideMaps; i++) {
                    var map2 = neighbourMap.clone();
                    map2.scale = SCALE;
                    map2.x = clanMap.x + ((i + 1) * MAPW);
                    stage.addChild(map2);
                }

                stage.addEventListener('mousedown', function(event) {
                        console.log("down");
                        cellPress(event.stageX, event.stageY);
                    }, false);
                
                stage.addEventListener('pressmove', function(event) {
                        console.log("move");
                        if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                            console.log("pressed");
                            cellPress(event.stageX, event.stageY);
                        } 
                        if(lockScroll == true) event.nativeEvent.preventDefault();
                    }, false);

                stage.addEventListener('pressup', function(event) {
                        console.log("release lock");
                        lockScroll = false;
                    }, false);

                for (var m = 0; m < mapsLayout.length; m++) {
                    var mapLayout = mapsLayout[m];
                    for (var x = 0; x < mapLayout.length; x++) {
                        var row = mapLayout[x];
                        for (var y = 0; y < row.length; y++) {
                            if (row[y].drawable) {
                                if (row[y].background) 
                                    stage.addChild(row[y].background);
                                if (row[y].symbol) 
                                    stage.addChild(row[y].symbol);
                            }
                        }
                    }
                }

                stage.update();
            }

            function exportJpeg() {
                let downloadLink = document.createElement('a');
                downloadLink.setAttribute('download', 'WarMap.png');
                let canvas = document.getElementById('canvas');
                let dataURL = canvas.toDataURL('image/png');
                let url = dataURL.replace(/^data:image\/png/,'data:application/octet-stream');
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            }

            function cellPress(stageX, stageY) {
                var m = Math.floor(stageX / MAPW);
                var x = (stageX - m * MAPW) / SCALE;
                var y = stageY / SCALE;
                var row = Math.floor(y / 208);
                var column = Math.floor(x / 208);
                var cell = mapsLayout[m][row][column];
                if (!cell) return;
                if (cell.drawable) {
                    console.log("acquire lock");
                    lockScroll = true;
                    if (cell.symbol) stage.removeChild(cell.symbol);
                    if (cell.background) stage.removeChild(cell.background);
                    if (selectedShield == null) {
                        cell.symbol = null;
                        cell.background = null;
                    }
                    else {
                        cell.symbol = new createjs.Bitmap(selectedShield.cacheCanvas);
                        // cell.symbol.cacheCanvas = selectedShield.cacheCanvas;
                        // cell.symbol.bitmapCache = selectedShield.bitmapCache;
                        cell.symbol.scale = Math.floor((150 * SCALE) / TBARH  * 100)/100;
                        cell.symbol.x = m * MAPW + column * 208 * SCALE + 25 * SCALE;
                        cell.symbol.y = row * 208 * SCALE + 25 * SCALE;
                        stage.addChild(cell.symbol);

                        cell.background = new createjs.Shape();
                        cell.background.graphics.beginFill("rgba(150,150,150,0.5)").drawRect(0, 0, 208 * SCALE, 208 * SCALE);
                        cell.background.x = m * MAPW + column * 208 * SCALE;
                        cell.background.y = row * 208 * SCALE;
                        stage.addChild(cell.background);
                        stage.addChild(cell.symbol);
                    }
                    stage.update();
                }
            }

        </script>
    </body>
</html>


