
<!DOCTYPE html>
<html>
    <head>
        <title>Fenrir Wrath</title>  
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600,400" rel="stylesheet" type="text/css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

        <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
        <script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>

        <style type="text/css">
            body {
                font-family: "Helvetica Neue Light","Open Sans",Helvetica;
                font-size: 14px;
            }
            select, option {
                font-size: 20px;
            }
            .avatar {
                vertical-align: middle;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: 1px solid lightgray;
            }
            /* The Modal (background) */
            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                padding-top: 100px; /* Location of the box */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }

            /* Modal Content */
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
            }

            /* The Close Button */
            .modal-content .close {
                color: #aaaaaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }

            .modal-content .close:hover,
            .modal-content .close:focus {
                color: #000;
                text-decoration: none;
                cursor: pointer;
            }

            .modal-content input[type=text], .modal-content select {
                width: 100%;
                padding: 12px 20px;
                margin: 8px 0;
                display: inline-block;
                border: 1px solid #ccc;
                border-radius: 4px;
                box-sizing: border-box;
            }

            .modal-content input[type=submit] {
                width: 100%;
                background-color: #4CAF50;
                color: white;
                padding: 14px 20px;
                margin: 8px 0;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            .modal-content input[type=submit]:hover {
                background-color: #45a049;
            }

            .modal-content div {
                border-radius: 5px;
                background-color: #f2f2f2;
                padding: 20px;
            }
        </style>
    </head>
    <body style="margin:0;">
        <script>
            var GoogleAuth;
            var SCOPE = 'https://www.googleapis.com/auth/drive.appdata';

            function handleClientLoad() {
                gapi.load('client:auth2', initClient);
            }
        
            function initClient() {
            
                var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

                gapi.client.init({
                    'apiKey': 'AIzaSyABcolZu_E4wz7-MEYgbxZLdCjj7Mimho4',
                    'clientId': '412525536632-17n9ero7spbmejco4ggraj16tngeats4.apps.googleusercontent.com',
                    'discoveryDocs': DISCOVERY_DOCS,
                    'scope': SCOPE
                }).then(function () {
                    GoogleAuth = gapi.auth2.getAuthInstance();
                
                    GoogleAuth.isSignedIn.listen(updateSigninStatus);
                
                    var user = GoogleAuth.currentUser.get();
                    setSigninStatus();
                
                    $('#avatar').click(function() {
                        handleAuthClick();
                    });
                    $('#revoke').click(function() {
                        revokeAccess();
                    });
                });
            }
        
            function handleAuthClick() {
                if (GoogleAuth.isSignedIn.get()) {
                    GoogleAuth.signIn({
                        prompt: 'select_account'
                    });
                } else {
                    GoogleAuth.signIn();
                }
            }
        
            function revokeAccess() {
                if (confirm("Are you sure? You will loose all your saved maps.")) {
                    GoogleAuth.disconnect();
                }
            }
        
            function setSigninStatus() {
                var user = GoogleAuth.currentUser.get();
                var isAuthorized = user.hasGrantedScopes(SCOPE);
                if (isAuthorized) {
                    // $('#sign-in-or-out-button').html('Change user');
                    $('#revoke').css('display', 'inline-block');
                    $('#deleteMap').css('display', 'inline-block');
                    $('#exportMap').css('display', 'inline-block');
                    $('#avatar').attr("src", user.getBasicProfile().getImageUrl());
                    loadSavedMaps();
                } else {
                    $('#sign-in-or-out-button').html('Sign In/Authorize');
                    $('#revoke').css('display', 'none');
                    $('#deleteMap').css('display', 'none');
                    $('#exportMap').css('display', 'none');
                    $('#auth-status').html('You have not authorized this app or you are ' +
                        'signed out.');
                    $("#savedMaps").find('option').remove().end().append('<option>No maps available.</option>');
                }
            }
        
            function updateSigninStatus() {
                setSigninStatus();
            }
        </script>
        

        <table id="headers" style="width:100%">
            <tr>
                <td>
                    <select id="savedMaps" style="height:50px;width:100%">
                        <option>No maps available.</option>
                    </select>
                </td>
                <td style="width:1%;white-space:nowrap;">
                    <button id="deleteMap"  style="display: none;">
                        <img src="delete.png">
                    </button>
                </td>
                <td style="width:1%;white-space:nowrap;">
                    <button id="exportMap"  style="display: none;" >
                        <img src="export.png">
                    </button>
                </td>
                <td>
                    <img id="avatar" class="avatar" title="login" src="avatar.png" alt="Avatar" >
                    <img id="revoke" class="avatar" title="revoke access" src="remove.png" alt="Revoke" style="display: none;">
                </td>
            </tr>
          </table>

        <div style="position: fixed;height: 100%;left: 0;right: 0;">
            <div id="toolbarCont" style="position:absolute;left:0;right:0;overflow: auto;">
                <canvas style="margin:0" id="toolbar" width="1500" height="32"></canvas>
            </div>
            <div id="canvasCont" style="position:absolute;left:0;right:0;bottom:0;overflow: auto;">
                <canvas style="margin:0;" id="canvas" width="500" height="800"></canvas>
            </div>
        </div>

        <div id="manaSettingsModal" class="modal">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <form id="manaForm">
                    <label for="islands1power">average power for 1x islands (k)</label>
                    <input type="text" id="islands1power" name="islands1power" required>
                    <label for="islands2power">average power for 2x islands (k)</label>
                    <input type="text" id="islands2power" name="islands2power" required>
                    <label for="islands3power">average power for 3x islands (k)</label>
                    <input type="text" id="islands3power" name="islands3power" required>
                    <label for="manarain1power">average power for 1x manarain (k)</label>
                    <input type="text" id="manarain1power" name="manarain1power" required>
                    <label for="manarain2power">average power for 2x manarain (k)</label>
                    <input type="text" id="manarain2power" name="manarain2power" required>
                    <label for="manarain3power">average power for 3x manarain (k)</label>
                    <input type="text" id="manarain3power" name="manarain3power" required>
                    <label for="hours">calculation hours</label>
                    <input type="text" id="hours" name="hours" required>
                    <label for="shield">shield used for calculation</label>
                    <select id="shield" name="shield">
                        <option value="blue">Blue shields</option>
                        <option value="red">Red shields</option>
                        <option value="green">Green shields</option>
                    </select>
                    <input type="submit" value="Save">
                </form>
            </div>
        </div>

        <script>
            var H, W, SCALE, MAPW, SQUARE;
            var clanMap, neighbourMap;
            var stage, toolbar;

            location.queryString = {};
            location.search.substr(1).split("&").forEach(function (pair) {
                if (pair === "") return;
                var parts = pair.split("=");
                location.queryString[parts[0]] = parts[1] &&
                    decodeURIComponent(parts[1].replace(/\+/g, " "));
            });

            var settings = {
                maps: 3,
                selectedShield: null,
                selectedBackground: null,
                manaShield: "blue",
                islands1Avg: 1,
                islands2Avg: 20,  
                islands3Avg: 35,
                manarain1Avg: 20,
                manarain2Avg: 40,
                manarain3Avg: 50,
                hours: 36
            }

            var mapSlots = [];

            var mapsLayout = [];

            var pixelRatio = (window.devicePixelRatio > 1 ? window.devicePixelRatio / 2 : 1)

            var TBARH = 45 * pixelRatio;

            var lockScroll = false;

            var curYPos = 0,
            curXPos = 0,
            curDown = false,
            scrolling = false;

            $(document).ready(function(){

                resize();
                resize();

                initializeMapSlots();

                $('.close').on("click", function() {
                    $('#manaSettingsModal').css("display", "none");
                });
                $("#manaForm").submit(function(e) {
                    e.preventDefault();
                    validateManaForm();
                });

                setTimeout(() => { 
                    var queue = new createjs.LoadQueue(true, "", "");
                    
                    queue.on("complete", function(event) {
                        // INIT MAP CANVAS
                        stage = new createjs.Stage("canvas");

                        createjs.Touch.enable( stage, true, false );
                        stage.preventSelection = false;
                        stage.enableMouseOver(100);

                        var clan = queue.getResult("clan");
                        clanMap = new createjs.Bitmap(clan);
                        var vicini = queue.getResult("vicini");
                        neighbourMap = new createjs.Bitmap(vicini);

                        // TOOLBAR
                        toolbar = new createjs.Stage("toolbar");
                        toolbar.enableMouseOver(100);

                        var pos = 0;

                        //MAP SIZE
                        var hitLabel = new createjs.Shape();
                        var sLabelBG = new createjs.Shape();
                        sLabelBG.name = "mapselBG";

                        var label1 = new createjs.Text(" 3 ", "100px Arial", "#555");
                        label1.name = "3maps";
                        hitLabel.graphics.beginFill("#000").drawRect(0, 0, label1.getMeasuredWidth(), label1.getMeasuredHeight());
                        label1.scale = TBARH / label1.getMeasuredHeight();
                        label1.x = pos;
                        label1.alpha = 0.5;
                        label1.hitArea = hitLabel;
                        label1.on("mouseover", handleInteraction);
                        label1.on("mouseout", handleInteraction);
                        label1.on("click", (event) => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 3;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        pos += label1.getMeasuredWidth() * label1.scale;
                        sLabelBG.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, label1.getMeasuredWidth(), label1.getMeasuredHeight());
                        sLabelBG.scale = label1.scale;
                        toolbar.addChild(sLabelBG);
                        toolbar.addChild(label1);

                        var label2 = new createjs.Text(" 5 ", "100px Arial", "#555");
                        label2.name = "5maps";
                        label2.scale = label1.scale;
                        label2.x = pos;
                        label2.alpha = 0.5;
                        label2.hitArea = hitLabel;
                        label2.on("click", () => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 5;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        label2.on("mouseover", handleInteraction);
                        label2.on("mouseout", handleInteraction);
                        pos += label2.getMeasuredWidth() * label1.scale;
                        toolbar.addChild(label2);

                        var label3 = new createjs.Text(" 7 ", "100px Arial", "#555");
                        label3.name = "7maps";
                        label3.scale = label1.scale;
                        label3.x = pos;
                        label3.alpha = 0.5;
                        label3.hitArea = hitLabel;
                        label3.on("click", () => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 7;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        label3.on("mouseover", handleInteraction);
                        label3.on("mouseout", handleInteraction);
                        pos += label3.getMeasuredWidth() * label1.scale;
                        toolbar.addChild(label3);

                        var mapc = new createjs.Shape();
                        mapc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, pos, TBARH);
                        toolbar.addChild(mapc);
                        // END MAP SIZE

                        // SHIELDS
                        var scudo = queue.getResult("scudo");
                        var divieto = queue.getResult("divieto");
                        
                        var startShields = pos;
                        var iconRect = new createjs.Shape();
                        iconRect.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, TBARH, TBARH);
                        iconRect.x = startShields;
                        toolbar.addChild(iconRect);

                        var emptyShield = new createjs.Bitmap(divieto);
                        var emptyhit = new createjs.Shape();
                        emptyhit.graphics.beginFill("#000").drawRect(0, 0, emptyShield.getBounds().width, emptyShield.getBounds().height).endFill();
                        emptyShield.scale = Math.floor((TBARH - 10) / (emptyShield.getBounds().height) * 100)/100;
                        emptyShield.x = pos + (TBARH / 2 - (emptyShield.getBounds().width * emptyShield.scale / 2));
                        emptyShield.y = (TBARH / 2 - (emptyShield.getBounds().height * emptyShield.scale / 2));
                        emptyShield.hitArea = emptyhit;
                        emptyShield.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields;
                            toolbar.update();
                            settings.selectedShield = null;
                            settings.selectedShieldSer = null;
                        }, false);
                        toolbar.addChild(emptyShield);
                        
                        var blueShield = new createjs.Bitmap(scudo);
                        blueShield.name = "blues";
                        blueShield.scale = Math.floor((TBARH - 10) / (blueShield.getBounds().height) * 100)/100;
                        var widthFactor = TBARH / 2 - (blueShield.getBounds().width * blueShield.scale / 2);
                        var heightFactor = TBARH / 2 - (blueShield.getBounds().height * blueShield.scale / 2);
                        blueShield.x = startShields + TBARH + widthFactor;
                        blueShield.y = heightFactor;
                        blueShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 38,75,150,0)
                        ];
                        blueShield.cache(0, 0, blueShield.getBounds().width, blueShield.getBounds().height);
                        var hit = new createjs.Shape();
                        hit.graphics.beginFill("#000").drawRect(0, 0, TBARH, TBARH).endFill();
                        blueShield.hitArea = hit;
                        blueShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH;
                            toolbar.update();
                            settings.selectedShield = blueShield;
                            settings.selectedShieldSer = "blue";
                        }, false);
                        toolbar.addChild(blueShield);

                        var redShield = blueShield.clone();
                        redShield.name = "reds";
                        redShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 191,33,47,0)
                        ];
                        redShield.cache(0, 0, redShield.getBounds().width, redShield.getBounds().height);
                        redShield.x = startShields + 2 * TBARH + widthFactor;
                        redShield.hitArea = hit;
                        redShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH * 2;
                            toolbar.update();
                            settings.selectedShield = redShield;
                            settings.selectedShieldSer = "red";
                        }, false);
                        toolbar.addChild(redShield);

                        var greenShield = blueShield.clone();
                        greenShield.name = "greens";
                        greenShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 0,111,60,0)
                        ];
                        greenShield.cache(0, 0, greenShield.getBounds().width, greenShield.getBounds().height);
                        greenShield.x = startShields + 3 * TBARH + widthFactor;
                        greenShield.hitArea = hit;
                        greenShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH * 3;
                            toolbar.update();
                            settings.selectedShield = greenShield;
                            settings.selectedShieldSer = "green";
                        }, false);
                        toolbar.addChild(greenShield);
                            
                        var shieldc = new createjs.Shape();
                        shieldc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH * 4, TBARH);
                        shieldc.x = startShields;
                        toolbar.addChild(shieldc);

                        var startBackground = startShields + 4 * TBARH;
                        
                        var backRect = new createjs.Shape();
                        backRect.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, TBARH, TBARH);
                        backRect.x = startBackground;
                        toolbar.addChild(backRect);

                        var emptyBackground = new createjs.Bitmap(divieto);
                        emptyBackground.name = "eBG";
                        emptyBackground.scale = Math.floor((TBARH - 10) / (emptyBackground.getBounds().height) * 100)/100;
                        emptyBackground.x = startBackground + (TBARH / 2 - (emptyBackground.getBounds().width * emptyBackground.scale / 2));
                        emptyBackground.y = (TBARH / 2 - (emptyBackground.getBounds().height * emptyBackground.scale / 2));
                        emptyBackground.hitArea = emptyhit;
                        emptyBackground.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground;
                            settings.selectedBackground = null;
                            settings.selectedBackgroundSer = null;
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(emptyBackground);
                        
                        var backBlue = new createjs.Shape();
                        backBlue.name = "bBG";
                        backBlue.graphics.beginFill("rgba(38,75,150)").drawRect(0, 0, TBARH, TBARH);
                        backBlue.x = startBackground + TBARH;
                        backBlue.on("mouseover", handleInteraction);
                        backBlue.on("mouseout", handleInteraction);
                        backBlue.alpha = 0.4;
                        backBlue.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH;
                            settings.selectedBackground = backBlue;
                            settings.selectedBackgroundSer = "blue";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backBlue);

                        var backRed = new createjs.Shape();
                        backRed.name = "rBG";
                        backRed.graphics.beginFill("rgba(191,33,47)").drawRect(0, 0, TBARH, TBARH);
                        backRed.x = startBackground + TBARH * 2;
                        backRed.on("mouseover", handleInteraction);
                        backRed.on("mouseout", handleInteraction);
                        backRed.alpha = 0.4;
                        backRed.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH * 2;
                            settings.selectedBackground = backRed;
                            settings.selectedBackgroundSer = "red";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backRed);

                        var backGreen = new createjs.Shape();
                        backGreen.name = "gBG";
                        backGreen.graphics.beginFill("rgba(0,111,60)").drawRect(0, 0, TBARH, TBARH);
                        backGreen.x = startBackground + TBARH * 3;
                        backGreen.on("mouseover", handleInteraction);
                        backGreen.on("mouseout", handleInteraction);
                        backGreen.alpha = 0.4;
                        backGreen.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH * 3;
                            settings.selectedBackground = backGreen;
                            settings.selectedBackgroundSer = "green";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backGreen);

                        var backc = new createjs.Shape();
                        backc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH * 4, TBARH);
                        backc.x = startBackground;
                        toolbar.addChild(backc);

                        var startDownload = startBackground + 4 * TBARH;

                        var dhit = new createjs.Shape();
                        var download = queue.getResult("download");
                        var downloadB = new createjs.Bitmap(download);
                        dhit.graphics.beginFill("#000").drawRect(0, 0, downloadB.getBounds().width, downloadB.getBounds().height);
                        downloadB.scale = Math.floor(TBARH / downloadB.getBounds().height * 100)/100;
                        downloadB.x = startDownload + TBARH / 2 - (downloadB.getBounds().width * downloadB.scale / 2);
                        downloadB.y = TBARH / 2 - (downloadB.getBounds().height * downloadB.scale / 2);
                        downloadB.hitArea = dhit;
                        downloadB.addEventListener('pressup', function(event) {
                            exportJpeg();
                        }, false);
                        toolbar.addChild(downloadB);

                        var downc = new createjs.Shape();
                        downc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        downc.x = startDownload;
                        toolbar.addChild(downc);
                        
                        var chit = new createjs.Shape();
                        var clear = queue.getResult("clear");
                        var clearB = new createjs.Bitmap(clear);
                        chit.graphics.beginFill("#000").drawRect(0, 0, clearB.getBounds().width, clearB.getBounds().height);
                        clearB.scale = Math.floor(TBARH / clearB.getBounds().height * 100)/100;
                        clearB.x = startDownload + TBARH + TBARH / 2 - (clearB.getBounds().width * clearB.scale / 2);
                        clearB.y = TBARH / 2 - (clearB.getBounds().height * clearB.scale / 2);
                        clearB.hitArea = chit;
                        clearB.addEventListener('pressup', function(event) {
                            if (hasDrawings() && confirm("Are you sure? This will reset current map.")) {
                                clearCanvas();
                            }
                        }, false);
                        toolbar.addChild(clearB);

                        var clearc = new createjs.Shape();
                        clearc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        clearc.x = startDownload + TBARH;
                        toolbar.addChild(clearc);
                        
                        var shit = new createjs.Shape();
                        var save = queue.getResult("save");
                        var saveB = new createjs.Bitmap(save);
                        shit.graphics.beginFill("#000").drawRect(0, 0, saveB.getBounds().width, saveB.getBounds().height);
                        saveB.scale = Math.floor(TBARH / saveB.getBounds().height * 100)/100;
                        saveB.x = startDownload + TBARH * 2 + TBARH / 2 - (saveB.getBounds().width * saveB.scale / 2);
                        saveB.y = TBARH / 2 - (saveB.getBounds().height * saveB.scale / 2);
                        saveB.hitArea = shit;
                        saveB.addEventListener('pressup', function(event) {
                            if (hasDrawings()) {
                                if (!GoogleAuth.isSignedIn.get()) {
                                    alert("Please sign in.");
                                }
                                else {
                                    var saveName = prompt("Che nome vuoi dare alla mappa?");
                                    if (saveName && saveName.length > 0) {

                                        var saveData = getMapSaveData();
                                        
                                        gapi.client.drive.files
                                            .list({
                                                q: 'name="' + saveName + '"',
                                                spaces: 'appDataFolder',
                                                fields: 'files(id)'
                                            }).then(
                                            function (data) {
                                                if (data.result.files.length == 0) {
                                                    gapi.client.drive.files
                                                        .create({
                                                            resource: {
                                                                name: saveName,
                                                                parents: ['appDataFolder']
                                                            },
                                                            fields: 'id'
                                                            }).then(function (data) {
                                                                saveMapData(data.result.id, saveData);
                                                            });
                                                }
                                                else {
                                                    saveMapData(data.result.files[0].id, saveData);
                                                }
                                            }
                                            );
                                    }
                                }
                            }
                        }, false);
                        toolbar.addChild(saveB);

                        var savec = new createjs.Shape();
                        savec.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        savec.x = startDownload + TBARH * 2;
                        toolbar.addChild(savec);
                        
                        var ihit = new createjs.Shape();
                        var importa = queue.getResult("import");
                        var importB = new createjs.Bitmap(importa);
                        ihit.graphics.beginFill("#000").drawRect(0, 0, importB.getBounds().width, importB.getBounds().height);
                        importB.scale = Math.floor((TBARH - 10) / importB.getBounds().height * 100)/100;
                        importB.x = startDownload + TBARH * 3 + TBARH / 2 - (importB.getBounds().width * importB.scale / 2);
                        importB.y = TBARH / 2 - (importB.getBounds().height * importB.scale / 2);
                        importB.hitArea = ihit;
                        importB.addEventListener('pressup', function(event) {
                            var ok = !hasDrawings();
                            if (!ok) {
                                ok = confirm("Are you sure? This will reset current map.");
                            }
                            if (ok) {
                                var input = $(document.createElement("input"));
                                input.attr("type", "file");
                                input.attr("accept", ".json");
                                input.bind("change", loadFiles);
                                input.trigger("click"); // opening dialog
                                return false; // avoiding navigation
                            }
                        }, false);
                        toolbar.addChild(importB);

                        var importc = new createjs.Shape();
                        importc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        importc.x = startDownload + TBARH * 3;
                        toolbar.addChild(importc);
                        
                        var ehit = new createjs.Shape();
                        var exportjson = queue.getResult("export");
                        var exportB = new createjs.Bitmap(exportjson);
                        ehit.graphics.beginFill("#000").drawRect(0, 0, exportB.getBounds().width, exportB.getBounds().height);
                        exportB.scale = Math.floor((TBARH - 10) / exportB.getBounds().height * 100)/100;
                        exportB.x = startDownload + TBARH * 4 + TBARH / 2 - (exportB.getBounds().width * exportB.scale / 2);
                        exportB.y = TBARH / 2 - (exportB.getBounds().height * exportB.scale / 2);
                        exportB.hitArea = ehit;
                        exportB.addEventListener('pressup', function(event) {
                            var ok = hasDrawings();
                            if (!ok) {
                                alert("There's no data to save on the map.");
                            }
                            else {
                                var saveData = getMapSaveData();
                                saveMapToFile("WarMap", JSON.stringify(saveData));
                            }
                        }, false);
                        toolbar.addChild(exportB);

                        var exportc = new createjs.Shape();
                        exportc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        exportc.x = startDownload + TBARH * 4;
                        toolbar.addChild(exportc);
                        
                        var calchit = new createjs.Shape();
                        var calc = queue.getResult("calc");
                        var calcB = new createjs.Bitmap(calc);
                        calchit.graphics.beginFill("#000").drawRect(0, 0, calcB.getBounds().width, calcB.getBounds().height);
                        calcB.scale = Math.floor((TBARH - 5) / calcB.getBounds().height * 100)/100;
                        calcB.x = startDownload + TBARH * 5 + TBARH / 2 - (calcB.getBounds().width * calcB.scale / 2);
                        calcB.y = TBARH / 2 - (calcB.getBounds().height * calcB.scale / 2);
                        calcB.hitArea = calchit;
                        calcB.addEventListener('pressup', function(event) {
                            $('#islands1power').val(settings.islands1Avg);
                            $('#islands2power').val(settings.islands2Avg);
                            $('#islands3power').val(settings.islands3Avg);
                            $('#manarain1power').val(settings.manarain1Avg);
                            $('#manarain2power').val(settings.manarain2Avg);
                            $('#manarain3power').val(settings.manarain3Avg);
                            $('#hours').val(settings.hours);
                            $('#shield').val(settings.manaShield);
                            $('#manaSettingsModal').css("display", "block");
                        }, false);
                        toolbar.addChild(calcB);

                        var manaText = new createjs.Text("0 k/m", "100px Arial", "#555");
                        manaText.name = "manaMin";
                        manaText.scale = TBARH / label1.getMeasuredHeight() / 2;
                        manaText.x = startDownload + TBARH * 6 + 100;
                        manaText.y = Math.floor(TBARH / 3);
                        manaText.textAlign = "center";
                        toolbar.addChild(manaText);

                        var manaText2 = new createjs.Text("0 M/h", "100px Arial", "#555");
                        manaText2.name = "manaHrs";
                        manaText2.scale = TBARH / label1.getMeasuredHeight() / 2;
                        manaText2.x = startDownload + TBARH * 6 + 200;
                        manaText2.y = Math.floor(TBARH / 3);
                        manaText2.textAlign = "center";
                        toolbar.addChild(manaText2);

                        var manaText3 = new createjs.Text("0 M in 0 hrs", "100px Arial", "#555");
                        manaText3.name = "manaTot";
                        manaText3.scale = TBARH / label1.getMeasuredHeight() / 2;
                        manaText3.x = startDownload + TBARH * 6 + 400;
                        manaText3.y = Math.floor(TBARH / 3);
                        manaText3.textAlign = "center";
                        toolbar.addChild(manaText3);

                        var manaText4 = new createjs.Text("0 M power", "100px Arial", "#555");
                        manaText4.name = "manaPow";
                        manaText4.scale = TBARH / label1.getMeasuredHeight() / 2;
                        manaText4.x = startDownload + TBARH * 6 + 600;
                        manaText4.y = Math.floor(TBARH / 3);
                        manaText4.textAlign = "center";
                        toolbar.addChild(manaText4);

                        var calcc = new createjs.Shape();
                        calcc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH + 680, TBARH);
                        calcc.x = startDownload + TBARH * 5;
                        toolbar.addChild(calcc);

                        toolbar.update();

                        applyToolbarSettings();
                        DrawMap();
                    });

                    if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
                        queue.loadFile({src:"mappaCLAN_mobile.jpg", id:"clan"});
                        queue.loadFile({src:"mappaVICINI_mobile.jpg", id:"vicini"});
                        SQUARE = 52;
                    }else{
                        queue.loadFile({src:"mappaCLAN.jpg", id:"clan"});
                        queue.loadFile({src:"mappaVICINI.jpg", id:"vicini"});
                        SQUARE = 208;
                    }
                    queue.loadFile({src:"shield.png", id:"scudo"});
                    queue.loadFile({src:"forbidden.png", id:"divieto"});
                    queue.loadFile({src:"download.png", id:"download"});
                    queue.loadFile({src:"clear.png", id:"clear"});
                    queue.loadFile({src:"save.png", id:"save"});
                    queue.loadFile({src:"import.png", id:"import"});
                    queue.loadFile({src:"exportjson.png", id:"export"});
                    queue.loadFile({src:"calculator.png", id:"calc"});

                }, 100);

                $('#deleteMap').on('click', function() {
                    deleteSavedMap();
                });

                $('#exportMap').on('click', function() {
                    exportSavedMap();
                });

                $('#savedMaps').on('change', function() { 
                    if (this.selectedIndex > 0) {
                        gapi.client.drive.files
                            .get({
                                fileId: this.value,
                                alt: 'media'
                            }).then(function (data) {
                                var result = data.result;
                                loadSavedMap(result);
                            });
                    }
                });
            });
            
            function applyToolbarSettings() {
                var label1 = toolbar.getChildByName("3maps");
                var label2 = toolbar.getChildByName("5maps");
                var label3 = toolbar.getChildByName("7maps");
                var sLabelBG = toolbar.getChildByName("mapselBG");
                if (settings.maps == 3) {
                    label1.selected = true;
                    label2.selected = false;
                    label3.selected = false;
                    label1.alpha = 1;
                    label2.alpha = 0.5;
                    label3.alpha = 0.5;
                    sLabelBG.x = 0;
                }
                else if (settings.maps == 5) {
                    label1.selected = false;
                    label2.selected = true;
                    label3.selected = false;
                    label1.alpha = 0.5;
                    label2.alpha = 1;
                    label3.alpha = 0.5;
                    sLabelBG.x = label2.x;

                }
                else if (settings.maps == 7) {
                    label1.selected = false;
                    label2.selected = false;
                    label3.selected = true;
                    label1.alpha = 0.5;
                    label2.alpha = 0.5;
                    label3.alpha = 1;
                    sLabelBG.x = label3.x;
                }

                
                var bBG = toolbar.getChildByName("bBG");
                var rBG = toolbar.getChildByName("rBG");
                var gBG = toolbar.getChildByName("gBG");
                if (settings.selectedBackgroundSer == null) {
                    bBG.selected = false;
                    rBG.selected = false;
                    gBG.selected = false;
                    bBG.alpha = 0.4;
                    rBG.alpha = 0.4;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "blue") {
                    bBG.selected = true;
                    rBG.selected = false;
                    gBG.selected = false;
                    bBG.alpha = 1;
                    rBG.alpha = 0.4;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "red") {
                    bBG.selected = false;
                    rBG.selected = true;
                    gBG.selected = false;
                    bBG.alpha = 0.4;
                    rBG.alpha = 1;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "green") {
                    bBG.selected = false;
                    rBG.selected = false;
                    gBG.selected = true;
                    bBG.alpha = 0.4;
                    rBG.alpha = 0.4;
                    gBG.alpha = 1;
                }

                toolbar.update();
            }
            
            function validateManaForm() {
                var form = document.forms["manaForm"];
                var islands1power = form["islands1power"].value;
                if (isNaN(islands1power) || islands1power < 1) {
                    alert("1x islands value invalid");
                    return false;
                }
                var islands2power = form["islands2power"].value;
                if (isNaN(islands2power) || islands2power < 1) {
                    alert("2x islands value invalid");
                    return false;
                }
                var islands3power = form["islands3power"].value;
                if (isNaN(islands3power) || islands3power < 1) {
                    alert("3x islands value invalid");
                    return false;
                }
                var manarain1power = form["manarain1power"].value;
                if (isNaN(manarain1power) || manarain1power < 1) {
                    alert("1x manarain value invalid");
                    return false;
                }
                var manarain2power = form["manarain2power"].value;
                if (isNaN(manarain2power) || manarain2power < 1) {
                    alert("2x manarain value invalid");
                    return false;
                }
                var manarain3power = form["manarain3power"].value;
                if (isNaN(manarain3power) || manarain3power < 1) {
                    alert("3x manarain value invalid");
                    return false;
                }
                var hours = form["hours"].value;
                if (isNaN(hours) || manarain3power < 1) {
                    alert("hours value invalid");
                    return false;
                }
                settings.islands1Avg = parseFloat(islands1power);
                settings.islands2Avg = parseFloat(islands2power);
                settings.islands3Avg = parseFloat(islands3power);
                settings.manarain1Avg = parseFloat(manarain1power);
                settings.manarain2Avg = parseFloat(manarain2power);
                settings.manarain3Avg = parseFloat(manarain3power);
                settings.hours = parseFloat(hours);
                settings.manaShield = form["shield"].value;
                calculateMana();
                $('#manaSettingsModal').css("display", "none");
                return false;
            }

            function handleInteraction(event) {
                if (event.target.selected) event.target.alpha = 1;
                else event.target.alpha = (event.type == "mouseover") ? 1 : 0.5; 
                toolbar.update();
            }

            function resize() {
                if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
                    H = (window.innerHeight) - TBARH - $('#headers').height();
                    $(".text").css("font-size", 14 * pixelRatio + "px");   
                    $("#savedMaps").css("height", 50 * pixelRatio + "px");   
                }else{
                    H = ($(window).height()) - TBARH - $('#headers').height();
                }
                $("#canvas").height(H + "px").attr("height", H);
                $("#toolbar").height(TBARH + "px").attr("height", TBARH);
                //$("#toolbar").width(15 * TBARH + "px").width("height", 15 * TBARH);
                $("#canvasCont").css("top", TBARH + "px");
            }

            function initializeMapSlots() {
                // 16 * 8 TODO: load from saved one
                mapSlots = [];
                for (var x = 0; x < 16; x++) {
                    var mapRow = [];
                    for (var y = 0; y < 8; y++) {
                        if (
                            (x == 0 && y < 6) ||
                            (x == 1 && (y > 0 && y < 5)) ||
                            (x == 2 && (y > 1 && y < 4)) ||
                            (x == 3 && y == 6) ||
                            (x == 4 && (y == 5 || y == 6)) ||
                            ((x == 6 || x == 7) && y == 4) ||
                            (x == 9 && (y == 2 || y == 5 || y == 6)) ||
                            ((x == 11 || x == 12) && (y == 2)) ||
                            (x == 14 && (y == 0 || y == 7))  ||
                            (x == 15 && (y < 2 || y > 5)) 
                            ) {
                            mapRow.push({
                                drawable: false,
                                islandManaMultiplier: x <= 5 ? 3 : (x <= 12 ? 2 : 1),
                                manaRainMultiplier: checkManaRain(x, y)
                            });
                            continue;
                        }
                        if (x == 15 && y == 4) {
                            mapRow.push({
                                drawable: false,
                                citadel: true,
                                islandManaMultiplier: x <= 5 ? 3 : (x <= 12 ? 2 : 1),
                                manaRainMultiplier: checkManaRain(x, y)
                            });
                            continue;
                        }
                        mapRow.push({
                            drawable: true,
                            islandManaMultiplier: x <= 5 ? 3 : (x <= 12 ? 2 : 1),
                            manaRainMultiplier: checkManaRain(x, y)
                        });
                    }
                    mapSlots.push(mapRow);
                }
            }

            function checkManaRain(x, y) {
                if (
                    (y == 0 && x >= 1 && x <= 2) ||
                    (y >= 6 && y <= 7 && x <= 2)
                ) {
                    return 5;
                }
                if (
                    (y == 0 && x >= 3 && x <= 5) ||
                    (y == 7 && x >= 3 && x <= 5) ||
                    (y == 6 && x == 5)
                ) {
                    return 3;
                }
                if (
                    (y == 0 && x >= 6 && x <= 8) ||
                    (y >= 6 && y <= 7 && x >= 6 && x <= 8)
                ) {
                    return 2;
                }
                return 1;
            }

            function DrawMap() {
                stage.removeAllChildren();

                SCALE = Math.floor(H / clanMap.getBounds().height * 100)/100;
                MAPW = clanMap.getBounds().width * SCALE;

                var mapBounds = clanMap.getBounds();

                W = MAPW * settings.maps;
                $("#canvas").width(W + "px").attr("width", W);

                mapsLayout = [];
                for (var m = 0; m < settings.maps; m++) {
                    var mapLayout = JSON.parse(JSON.stringify(mapSlots));
                    mapsLayout.push(mapLayout);
                }

                var sideMaps = Math.floor(settings.maps / 2);

                clanMap.scale = SCALE;
                clanMap.x = sideMaps * MAPW;

                for (var i = 0; i < sideMaps; i++) {
                    var map1 = neighbourMap.clone();
                    map1.scale = SCALE;
                    map1.x = i * MAPW;
                    map1.cache(0, 0, mapBounds.width, mapBounds.height);
                    stage.addChild(map1);
                }

                var centerMap = clanMap.clone();
                centerMap.cache(0, 0, mapBounds.width, mapBounds.height);
                stage.addChild(centerMap);
                
                for (var i = 0; i < sideMaps; i++) {
                    var map2 = neighbourMap.clone();
                    map2.scale = SCALE;
                    map2.x = clanMap.x + ((i + 1) * MAPW);
                    map2.cache(0, 0, mapBounds.width, mapBounds.height);
                    stage.addChild(map2);
                }

                stage.addEventListener('mousedown', function(event) {
                        if (!scrolling && !cellPress(event.stageX, event.stageY)) {
                            curDown = true;
                            if (event.nativeEvent.type = "touchstart" && event.nativeEvent.touches) {
                                curXPos = event.nativeEvent.touches[0].pageX;
                                curYPos = event.nativeEvent.touches[0].pageY;
                            }
                            else {
                                curYPos = event.nativeEvent.pageY; 
                                curXPos = event.nativeEvent.pageX;
                            }
                        }
                    }, false);
                
                stage.addEventListener('pressmove', function(event) {
                        if(!scrolling && (event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove")) {
                            cellPress(event.stageX, event.stageY);
                        } 
                        if(lockScroll == true) event.nativeEvent.preventDefault();
                        if(curDown == true){
                            scrolling = true;
                            var x = event.nativeEvent.pageX;
                            var y = event.nativeEvent.pageY;
                            if (event.nativeEvent.type = "touchstart" && event.nativeEvent.touches) {
                                x = event.nativeEvent.touches[0].pageX;
                                y = event.nativeEvent.touches[0].pageY;
                            }
                            $('#canvasCont').scrollLeft($('#canvasCont').scrollLeft() + (curXPos - x))
                                            .scrollTop($('#canvasCont').scrollTop() + (curYPos - y));
                            if (event.nativeEvent.type = "touchstart" && event.nativeEvent.touches) {
                                curXPos = event.nativeEvent.touches[0].pageX;
                                curYPos = event.nativeEvent.touches[0].pageY;
                            }
                            else {
                                curYPos = event.nativeEvent.pageY; 
                                curXPos = event.nativeEvent.pageX;
                            }
                        }
                    }, false);

                stage.addEventListener('pressup', function(event) {
                        lockScroll = false;
                        curDown = false;
                        scrolling = false;
                    }, false);

                for (var m = 0; m < mapsLayout.length; m++) {
                    var mapLayout = mapsLayout[m];
                    for (var x = 0; x < mapLayout.length; x++) {
                        var row = mapLayout[x];
                        for (var y = 0; y < row.length; y++) {
                            if (row[y].drawable) {
                                if (row[y].background) 
                                    stage.addChild(row[y].background);
                                if (row[y].symbol) 
                                    stage.addChild(row[y].symbol);
                            }
                        }
                    }
                }
                calculateMana();
                stage.update();
            }

            function cellPress(stageX, stageY) {
                var m = Math.floor(stageX / MAPW);
                var x = (stageX - m * MAPW) / SCALE;
                var y = stageY / SCALE;
                var row = Math.floor(y / SQUARE);
                var column = Math.floor(x / SQUARE);
                var cell = mapsLayout[m][row][column];
                if (!cell) return false;
                if (cell.drawable) {
                    lockScroll = true;
                    if (cell.symbol) stage.removeChild(cell.symbol);
                    if (cell.background) stage.removeChild(cell.background);

                    if (settings.selectedBackground == null) {
                        cell.background = null;
                        cell.backgroundSer = null;
                    }
                    else {
                        cell.background = settings.selectedBackground.clone();
                        cell.backgroundSer = settings.selectedBackgroundSer;
                        cell.background.alpha = 0.6;
                        cell.background.scale = Math.floor((SQUARE * SCALE) / TBARH  * 100)/100;
                        cell.background.cache(0, 0, TBARH, TBARH);
                        cell.background.x = m * MAPW + column * SQUARE * SCALE;
                        cell.background.y = row * SQUARE * SCALE;

                        cell.background.addEventListener('pressmove', function(event) {
                            if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                cellPress(event.stageX, event.stageY);
                            } 
                            if(lockScroll == true) event.nativeEvent.preventDefault();
                            }, false);

                        stage.addChild(cell.background);
                    }
                    
                    if (settings.selectedShield == null) {
                        cell.symbol = null;
                        cell.symbolSer = null;
                    }
                    else {
                        cell.symbol = new createjs.Bitmap(settings.selectedShield.cacheCanvas);
                        cell.symbolSer = settings.selectedShieldSer;
                        cell.symbol.scale = Math.floor(((SQUARE * 0.50) * pixelRatio * SCALE) / TBARH  * 100)/100;
                        cell.symbol.cache(0, 0, cell.symbol.getBounds().width, cell.symbol.getBounds().height);
                        cell.symbol.x = m * MAPW + column * SQUARE * SCALE + (SQUARE * 0.2) * SCALE;
                        cell.symbol.y = row * SQUARE * SCALE + (SQUARE * 0.2) * SCALE;
                        cell.symbol.addEventListener('pressmove', function(event) {
                            if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                cellPress(event.stageX, event.stageY);
                            } 
                            if(lockScroll == true) event.nativeEvent.preventDefault();
                            }, false);
                        stage.addChild(cell.symbol);
                    }
                    calculateMana();
                    stage.update();
                    return true;
                }
                return false;
            }

            function hasDrawings() {
                return mapsLayout.find(
                    (mapLayout) => {
                        return mapLayout.find(
                            (row) => {
                                return row.find(
                                    (el) => {
                                        return el.symbol || el.background;
                                    }
                                )
                            }
                        )
                    }
                ) != undefined;
            }

            function exportJpeg() {
                let downloadLink = document.createElement('a');
                downloadLink.setAttribute('download', 'WarMap.jpeg');
                let canvas = document.getElementById('canvas');
                let dataURL = canvas.toDataURL('image/jpeg', 0.5);
                let url = dataURL.replace(/^data:image\/jpeg/,'data:application/octet-stream');
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            }

            function loadFiles() {
                const fileList = this.files; /* now you can work with the file list */
                var fr = new FileReader();
                fr.onload = function () {
                    loadSavedMap(JSON.parse(fr.result));
                } 
                fr.readAsText(this.files[0]);
            }

            function getMapSaveData() {
                return {
                    mapNumber: settings.maps,
                    islands1avgpwr: settings.islands1Avg,
                    islands2avgpwr: settings.islands2Avg,
                    islands3avgpwr: settings.islands3Avg,
                    manarain1avgpwr: settings.manarain1Avg,
                    manarain2avgpwr: settings.manarain2Avg,
                    manarain3avgpwr: settings.manarain3Avg,
                    drawings: mapsLayout.map((ml) =>{
                        return ml.map((row) => {
                            return row.map((c) => {
                                var el = {
                                    drawable: c.drawable
                                }
                                if (c.citadel != undefined) {
                                    el.citadel = c.citadel;
                                }
                                if (c.backgroundSer != undefined) {
                                    el.backgroundSer = c.backgroundSer;
                                }
                                if (c.symbolSer != undefined) {
                                    el.symbolSer = c.symbolSer;
                                }
                                return el;
                            });
                        });
                    })
                };
            }

            function loadSavedMap(result) {
                settings.maps = result.mapNumber;
                settings.islands1Avg = result.islands1avgpwr;
                settings.islands2Avg = result.islands2avgpwr;
                settings.islands3Avg = result.islands3avgpwr;
                settings.manarain1Avg = result.manarain1avgpwr;
                settings.manarain2Avg = result.manarain2avgpwr;
                settings.manarain3Avg = result.manarain3avgpwr;
                clearCanvas();
                DrawMap();
                var bBG = toolbar.getChildByName("bBG");
                var rBG = toolbar.getChildByName("rBG");
                var gBG = toolbar.getChildByName("gBG");
                var blues = toolbar.getChildByName("blues");
                var reds = toolbar.getChildByName("reds");
                var greens = toolbar.getChildByName("greens");
                mapsLayout = result.drawings.map(
                    (mapLayout, m) => {
                        return mapLayout.map(
                            (r, row) => {
                                return r.map(
                                    (cell, column) => {
                                        if (cell.drawable && cell.backgroundSer) {
                                            if (cell.backgroundSer == "blue") cell.background = bBG.clone();
                                            if (cell.backgroundSer == "red") cell.background = rBG.clone();
                                            if (cell.backgroundSer == "green") cell.background = gBG.clone();
                                            cell.background.alpha = 0.6;
                                            cell.background.scale = Math.floor((SQUARE * SCALE) / TBARH  * 100)/100;
                                            cell.background.cache(0, 0, TBARH, TBARH);
                                            cell.background.x = m * MAPW + column * SQUARE * SCALE;
                                            cell.background.y = row * SQUARE * SCALE;

                                            cell.background.addEventListener('pressmove', function(event) {
                                                if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                                    cellPress(event.stageX, event.stageY);
                                                } 
                                                if(lockScroll == true) event.nativeEvent.preventDefault();
                                                }, false);

                                            stage.addChild(cell.background);
                                        }
                                        if (cell.drawable && cell.symbolSer) {
                                            if (cell.symbolSer == "blue") cell.symbol = new createjs.Bitmap(blues.cacheCanvas);
                                            if (cell.symbolSer == "red") cell.symbol = new createjs.Bitmap(reds.cacheCanvas);
                                            if (cell.symbolSer == "green") cell.symbol = new createjs.Bitmap(greens.cacheCanvas);
                                            cell.symbol.scale = Math.floor(((SQUARE * 0.8) * pixelRatio * SCALE) / TBARH  * 100)/100;
                                            cell.symbol.cache(0, 0, cell.symbol.getBounds().width, cell.symbol.getBounds().height);
                                            cell.symbol.x = m * MAPW + column * SQUARE * SCALE + (SQUARE * 0.05) * SCALE;
                                            cell.symbol.y = row * SQUARE * SCALE + (SQUARE * 0.05) * SCALE;
                                            cell.symbol.addEventListener('pressmove', function(event) {
                                                if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                                    cellPress(event.stageX, event.stageY);
                                                } 
                                                if(lockScroll == true) event.nativeEvent.preventDefault();
                                                }, false);
                                            stage.addChild(cell.symbol);
                                        }
                                        return cell;
                                    });
                            });
                    });
                calculateMana();
                stage.update();
            }

            function clearCanvas() {
                mapsLayout.map(
                    (mapLayout) => {
                        mapLayout.map(
                            (row) => {
                                row.map(
                                    (el) => {
                                        if (el.symbol != null) {
                                            stage.removeChild(el.symbol);
                                            el.symbol = null;
                                            el.symbolSer = null;
                                        }
                                        if (el.background) {
                                            stage.removeChild(el.background);
                                            el.background = null;
                                            el.backgroundSer = null;
                                        }
                                    }
                                )
                            }
                        )
                    }
                );
                stage.update();
            }
            
            var saveMapData = function (fileId, appData) {
                return gapi.client.request({
                    path: '/upload/drive/v3/files/' + fileId,
                    method: 'PATCH',
                    params: {
                    uploadType: 'media'
                    },
                    body: JSON.stringify(appData)
                }).then(function(data) {
                    loadSavedMaps();
                });
            };

            var deleteMapData = function (fileId) {
                return gapi.client.request({
                    path: '/drive/v3/files/' + fileId,
                    method: 'DELETE'
                }).then(function(data) {
                    loadSavedMaps();
                });
            };

            function loadSavedMaps() {
                gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    fields: 'files(id, name)'
                }).then(function(response) {
                    var files = response.result.files;
                    $("#savedMaps").find('option').remove();
                    if (files && files.length > 0) {
                        $('#savedMaps').append('<option>Choose Map...</option>');
                        for (var i = 0; i < files.length; i++) {
                            var file = files[i];
                            $('#savedMaps').append('<option value="'+file.id+'">'+file.name+'</option>');
                        }
                    } else {
                        $('#savedMaps').append('<option>No maps available.</option>');
                    }
                });
            }

            function exportSavedMap() {
                var fileId = $('#savedMaps').val();
                if (fileId != null && fileId.length > 1) {
                    
                    gapi.client.drive.files
                        .get({
                            fileId: fileId,
                            alt: 'media'
                        }).then(function (data) {
                            saveMapToFile(file, JSON.stringify(data.result));
                        });
                }
            }
            
            function saveMapToFile(mapname, mapdata) {
                let downloadLink = document.createElement('a');
                downloadLink.setAttribute('download', mapname + '.json');
                var file = new Blob([mapdata], {type: 'text/plain'});
                downloadLink.href = URL.createObjectURL(file);
                downloadLink.click();
            }

            function deleteSavedMap() {
                var fileId = $('#savedMaps').val();
                if (fileId != null && fileId.length > 1 && confirm("Are you sure? The map " + $( "#savedMaps option:selected" ).text() + " will be deleted permanently.")) {
                    deleteMapData(fileId);
                }
            }
            
            function calculateMana() {
                var manapersecond = 0;
                var totalPower = 0;
                mapsLayout.forEach(
                    (mapLayout, m) => {
                        mapLayout.forEach(
                            (r, row) => {
                                r.forEach(
                                    (cell, column) => {
                                        if (cell.drawable && cell.symbolSer && cell.symbolSer == settings.manaShield) {
                                            var pwr = 
                                                cell.manaRainMultiplier == 1 ?
                                                (cell.islandManaMultiplier == 1 ? settings.islands1Avg : (cell.islandManaMultiplier == 2 ? settings.islands2Avg : settings.islands3Avg)) :
                                                (cell.manaRainMultiplier == 2 ? settings.manarain1Avg : (cell.manaRainMultiplier == 3 ? settings.manarain2Avg : settings.manarain3Avg));
                                            
                                            var manaRainMultiplier = cell.manaRainMultiplier;
                                            if (manaRainMultiplier == 5) {
                                                if (column == 0 && m > 0) {
                                                    var center = mapsLayout[m-1][1][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column >= 6) {
                                                    var center = mapsLayout[m][1][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column == 0 && m == 0) {
                                                    manaRainMultiplier = 1;
                                                }
                                            }

                                            if (manaRainMultiplier == 3) {
                                                if (column == 0 && m > 0) {
                                                    var center = mapsLayout[m-1][4][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column >= 6) {
                                                    var center = mapsLayout[m][1][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column == 0 && m == 0) {
                                                    manaRainMultiplier = 1;
                                                }
                                            }

                                            if (manaRainMultiplier == 2) {
                                                if (column == 0 && m > 0) {
                                                    var center = mapsLayout[m-1][7][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column >= 6) {
                                                    var center = mapsLayout[m][1][7];
                                                    if(center.symbolSer == null) {
                                                        manaRainMultiplier = 1;
                                                    }
                                                    else if (center.symbolSer != settings.manaShield) {
                                                        manaRainMultiplier = 0.5;
                                                    }
                                                }
                                                else if (column == 0 && m == 0) {
                                                    manaRainMultiplier = 1;
                                                }
                                            }

                                            manapersecond += pwr * cell.islandManaMultiplier * manaRainMultiplier;
                                            totalPower += pwr;
                                        }
                                    });
                            });
                    });
                
                var manaperhour = manapersecond * 60;
                var manaperperiod = manaperhour * settings.hours;
                toolbar.getChildByName("manaMin").text = `${Math.floor(manapersecond / 10) / 100} k/m`;
                toolbar.getChildByName("manaHrs").text = `${Math.floor(manaperhour / 10000) / 100} M/h`;
                toolbar.getChildByName("manaTot").text = `${Math.floor(manaperperiod / 10000) / 100} M in ${settings.hours} hrs`;
                toolbar.getChildByName("manaPow").text = `${Math.floor(totalPower / 10) / 100} M power`;
                toolbar.update();
            }
        </script>

        <script async defer src="https://apis.google.com/js/api.js"
                onload="this.onload=function(){};handleClientLoad()"
                onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>

        <div style="position: absolute; bottom:0;">
            Icons made by <a href="https://www.flaticon.com/authors/pixel-perfect" title="Pixel perfect">Pixel perfect</a>, <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> and <a href="https://www.flaticon.com/authors/smashicons" title="Smashicons">Smashicons</a> from <a href="https://www.flaticon.com/" title="Flaticon"> www.flaticon.com</a>
        </div>
    </body>
</html>


