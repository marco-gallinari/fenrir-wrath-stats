
<!DOCTYPE html>
<html>
    <head>
        <title>Fenrir Wrath</title>  
        <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600,400" rel="stylesheet" type="text/css">
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>
        <script src="https://code.createjs.com/1.0.0/preloadjs.min.js"></script>

        <style type="text/css">
            /* #canvas { 
                width: 100vw;
                height: 100vh;
            } */
        </style>
    </head>
    <body style="margin:0;">
        <canvas style="margin:0;position:absolute;top:0;" id="toolbar" width="2500" height="32"></canvas>
        <canvas style="margin:0;position:absolute;top:32px;" id="canvas" width="500" height="800"></canvas>
        <div style="margin:0;position:absolute;top:1200px;" id="navigator"></div>
        <script>
            var H, W, SCALE, MAPW;
            var clanMap, neighbourMap;
            var stage, toolbar;

            location.queryString = {};
            location.search.substr(1).split("&").forEach(function (pair) {
                if (pair === "") return;
                var parts = pair.split("=");
                location.queryString[parts[0]] = parts[1] &&
                    decodeURIComponent(parts[1].replace(/\+/g, " "));
            });

            var settings = {
                maps: 5,
                selectedShield: null,
                selectedBackground: null
            }

            var mapSlots = [];

            var mapsLayout = [];

            var TBARH = 45 * window.devicePixelRatio;

            var lockScroll = false;

            function hasDrawings() {
                return mapsLayout.find(
                    (mapLayout) => {
                        return mapLayout.find(
                            (row) => {
                                return row.find(
                                    (el) => {
                                        return el.symbol || el.bitmap;
                                    }
                                )
                            }
                        )
                    }
                ) != undefined;
            }

            function resize() {
                $('#navigator').text(navigator.userAgent);
                if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){
                    H = (window.innerHeight - 50);
                }else{
                    H = ($(window).height() - 50);
                }
                $("#canvas").height(H + "px").attr("height", H);
                $("#toolbar").height(TBARH + "px").attr("height", TBARH);
                $("#canvas").css("top", TBARH + "px");
            }
            
            function handleInteraction(event) {
                if (event.target.selected) event.target.alpha = 1;
                else event.target.alpha = (event.type == "mouseover") ? 1 : 0.5; 
                toolbar.update();
            }

            function applyToolbarSettings() {
                var label1 = toolbar.getChildByName("3maps");
                var label2 = toolbar.getChildByName("5maps");
                var label3 = toolbar.getChildByName("7maps");
                var sLabelBG = toolbar.getChildByName("mapselBG");
                if (settings.maps == 3) {
                    label1.selected = true;
                    label2.selected = false;
                    label3.selected = false;
                    label1.alpha = 1;
                    label2.alpha = 0.5;
                    label3.alpha = 0.5;
                    sLabelBG.x = 0;
                }
                else if (settings.maps == 5) {
                    label1.selected = false;
                    label2.selected = true;
                    label3.selected = false;
                    label1.alpha = 0.5;
                    label2.alpha = 1;
                    label3.alpha = 0.5;
                    sLabelBG.x = label2.x;

                }
                else if (settings.maps == 7) {
                    label1.selected = false;
                    label2.selected = false;
                    label3.selected = true;
                    label1.alpha = 0.5;
                    label2.alpha = 0.5;
                    label3.alpha = 1;
                    sLabelBG.x = label3.x;
                }

                
                var bBG = toolbar.getChildByName("bBG");
                var rBG = toolbar.getChildByName("rBG");
                var gBG = toolbar.getChildByName("gBG");
                if (settings.selectedBackgroundSer == null) {
                    bBG.selected = false;
                    rBG.selected = false;
                    gBG.selected = false;
                    bBG.alpha = 0.4;
                    rBG.alpha = 0.4;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "blue") {
                    bBG.selected = true;
                    rBG.selected = false;
                    gBG.selected = false;
                    bBG.alpha = 1;
                    rBG.alpha = 0.4;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "red") {
                    bBG.selected = false;
                    rBG.selected = true;
                    gBG.selected = false;
                    bBG.alpha = 0.4;
                    rBG.alpha = 1;
                    gBG.alpha = 0.4;
                }
                else if (settings.selectedBackgroundSer == "green") {
                    bBG.selected = false;
                    rBG.selected = false;
                    gBG.selected = true;
                    bBG.alpha = 0.4;
                    rBG.alpha = 0.4;
                    gBG.alpha = 1;
                }

                toolbar.update();
            }

            function initializeMapSlots() {
                // 16 * 8 TODO: load from saved one
                mapSlots = [];
                for (var x = 0; x < 16; x++) {
                    var mapRow = [];
                    for (var y = 0; y < 8; y++) {
                        if (
                            (x == 0 && y < 6) ||
                            (x == 1 && (y > 0 && y < 5)) ||
                            (x == 2 && (y > 1 && y < 4)) ||
                            (x == 3 && y == 6) ||
                            (x == 4 && (y == 5 || y == 6)) ||
                            ((x == 6 || x == 7) && y == 4) ||
                            (x == 9 && (y == 2 || y == 5 || y == 6)) ||
                            ((x == 11 || x == 12) && (y == 2)) ||
                            (x == 14 && (y == 0 || y == 7))  ||
                            (x == 15 && (y < 2 || y > 5)) 
                            ) {
                            mapRow.push({
                                drawable: false
                            });
                            continue;
                        }
                        if (x == 15 && y == 4) {
                            mapRow.push({
                                drawable: false,
                                citadel: true
                            });
                            continue;
                        }
                        mapRow.push({
                            drawable: true
                        });
                    }
                    mapSlots.push(mapRow);
                }
            }

            $(document).ready(function(){

                resize();
                resize();
                
                initializeMapSlots();

                setTimeout(() => { 
                    var queue = new createjs.LoadQueue(true, "", "");
                    
                    queue.on("complete", function(event) {
                        // INIT MAP CANVAS
                        stage = new createjs.Stage("canvas");

                        createjs.Touch.enable( stage, true, true );
                        stage.preventSelection = false;
                        stage.enableMouseOver(100);

                        var clan = queue.getResult("clan");
                        clanMap = new createjs.Bitmap(clan);
                        var vicini = queue.getResult("vicini");
                        neighbourMap = new createjs.Bitmap(vicini);

                        // TOOLBAR
                        toolbar = new createjs.Stage("toolbar");
                        toolbar.enableMouseOver(100);

                        var pos = 0;

                        //MAP SIZE
                        var hitLabel = new createjs.Shape();
                        var sLabelBG = new createjs.Shape();
                        sLabelBG.name = "mapselBG";

                        var label1 = new createjs.Text(" 3 ", "100px Arial", "#555");
                        label1.name = "3maps";
                        hitLabel.graphics.beginFill("#000").drawRect(0, 0, label1.getMeasuredWidth(), label1.getMeasuredHeight());
                        label1.scale = TBARH / label1.getMeasuredHeight();
                        label1.x = pos;
                        label1.alpha = 0.5;
                        label1.hitArea = hitLabel;
                        label1.on("mouseover", handleInteraction);
                        label1.on("mouseout", handleInteraction);
                        label1.on("click", (event) => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 3;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        pos += label1.getMeasuredWidth() * label1.scale * window.devicePixelRatio;
                        sLabelBG.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, label1.getMeasuredWidth(), label1.getMeasuredHeight());
                        sLabelBG.scale = label1.scale;
                        toolbar.addChild(sLabelBG);
                        toolbar.addChild(label1);

                        var label2 = new createjs.Text(" 5 ", "100px Arial", "#555");
                        label2.name = "5maps";
                        label2.scale = label1.scale;
                        label2.x = pos;
                        label2.alpha = 0.5;
                        label2.hitArea = hitLabel;
                        label2.on("click", () => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 5;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        label2.on("mouseover", handleInteraction);
                        label2.on("mouseout", handleInteraction);
                        pos += label2.getMeasuredWidth() * label1.scale * window.devicePixelRatio;
                        toolbar.addChild(label2);

                        var label3 = new createjs.Text(" 7 ", "100px Arial", "#555");
                        label3.name = "7maps";
                        label3.scale = label1.scale;
                        label3.x = pos;
                        label3.alpha = 0.5;
                        label3.hitArea = hitLabel;
                        label3.on("click", () => {
                            if (!hasDrawings() || confirm("Are you sure? This will reset current map.")) {
                                settings.maps = 7;
                                applyToolbarSettings();
                                DrawMap();
                            }
                        });
                        label3.on("mouseover", handleInteraction);
                        label3.on("mouseout", handleInteraction);
                        pos += label3.getMeasuredWidth() * label1.scale * window.devicePixelRatio;
                        toolbar.addChild(label3);

                        var mapc = new createjs.Shape();
                        mapc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, pos, TBARH);
                        toolbar.addChild(mapc);

                        // END MAP SIZE

                        // SHIELDS
                        var scudo = queue.getResult("scudo");
                        var divieto = queue.getResult("divieto");
                        
                        var startShields = pos;
                        var iconRect = new createjs.Shape();
                        iconRect.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, TBARH, TBARH);
                        iconRect.x = startShields;
                        toolbar.addChild(iconRect);

                        var emptyShield = new createjs.Bitmap(divieto);
                        emptyShield.scale = Math.floor((TBARH - 10 * window.devicePixelRatio) / (emptyShield.getBounds().height * window.devicePixelRatio) * 100)/100;
                        emptyShield.x = pos + (TBARH / 2 - (emptyShield.getBounds().width * emptyShield.scale / 2));
                        emptyShield.y = (TBARH / 2 - (emptyShield.getBounds().height * emptyShield.scale / 2));
                        var hit = new createjs.Shape();
                        hit.graphics.beginFill("#000").drawRect(0, 0, TBARH, TBARH).endFill();
                        emptyShield.hitArea = hit;
                        emptyShield.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields;
                            toolbar.update();
                            settings.selectedShield = null;
                            settings.selectedShieldSer = null;
                        }, false);
                        toolbar.addChild(emptyShield);
                        
                        var blueShield = new createjs.Bitmap(scudo);
                        blueShield.scale = Math.floor((TBARH - 10 * window.devicePixelRatio) / (blueShield.getBounds().height * window.devicePixelRatio) * 100)/100;
                        var widthFactor = TBARH / 2 - (blueShield.getBounds().width * blueShield.scale / 2);
                        var heightFactor = TBARH / 2 - (blueShield.getBounds().height * blueShield.scale / 2);
                        blueShield.x = startShields + TBARH + widthFactor;
                        blueShield.y = heightFactor;
                        blueShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 38,75,150,0)
                        ];
                        blueShield.cache(0, 0, blueShield.getBounds().width, blueShield.getBounds().height);
                        blueShield.hitArea = hit;
                        blueShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH;
                            toolbar.update();
                            settings.selectedShield = blueShield;
                            settings.selectedShieldSer = "blue";
                        }, false);
                        toolbar.addChild(blueShield);

                        var redShield = blueShield.clone();
                        redShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 191,33,47,0)
                        ];
                        redShield.cache(0, 0, redShield.getBounds().width, redShield.getBounds().height);
                        redShield.x = startShields + 2 * TBARH + widthFactor;
                        redShield.hitArea = hit;
                        redShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH * 2;
                            toolbar.update();
                            settings.selectedShield = redShield;
                            settings.selectedShieldSer = "red";
                        }, false);
                        toolbar.addChild(redShield);

                        var greenShield = blueShield.clone();
                        greenShield.filters = [
                                new createjs.ColorFilter(0,0,0,1, 0,111,60,0)
                        ];
                        greenShield.cache(0, 0, greenShield.getBounds().width, greenShield.getBounds().height);
                        greenShield.x = startShields + 3 * TBARH + widthFactor;
                        greenShield.hitArea = hit;
                        greenShield.addEventListener('pressup', function(event) {
                            event.nativeEvent.preventDefault();
                            iconRect.x = startShields + TBARH * 3;
                            toolbar.update();
                            settings.selectedShield = greenShield;
                            settings.selectedShieldSer = "green";
                        }, false);
                        toolbar.addChild(greenShield);
                            
                        var shieldc = new createjs.Shape();
                        shieldc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH * 4, TBARH);
                        shieldc.x = startShields;
                        toolbar.addChild(shieldc);

                        var startBackground = startShields + 4 * TBARH;
                        
                        var backRect = new createjs.Shape();
                        backRect.graphics.beginFill("rgba(180,180,180,0.5)").drawRect(0, 0, TBARH, TBARH);
                        backRect.x = startBackground;
                        toolbar.addChild(backRect);

                        var emptyBackground = new createjs.Bitmap(divieto);
                        emptyBackground.name = "eBG";
                        emptyBackground.scale = Math.floor((TBARH - 10 * window.devicePixelRatio) / (emptyBackground.getBounds().height * window.devicePixelRatio) * 100)/100;
                        emptyBackground.x = startBackground + (TBARH / 2 - (emptyBackground.getBounds().width * emptyBackground.scale / 2));
                        emptyBackground.y = (TBARH / 2 - (emptyBackground.getBounds().height * emptyBackground.scale / 2));
                        emptyBackground.hitArea = hit;
                        emptyBackground.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground;
                            settings.selectedBackground = null;
                            settings.selectedBackgroundSer = null;
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(emptyBackground);
                        
                        var backBlue = new createjs.Shape();
                        backBlue.name = "bBG";
                        backBlue.graphics.beginFill("rgba(38,75,150)").drawRect(0, 0, TBARH, TBARH);
                        backBlue.x = startBackground + TBARH;
                        backBlue.on("mouseover", handleInteraction);
                        backBlue.on("mouseout", handleInteraction);
                        backBlue.alpha = 0.4;
                        backBlue.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH;
                            settings.selectedBackground = backBlue;
                            settings.selectedBackgroundSer = "blue";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backBlue);

                        var backRed = new createjs.Shape();
                        backRed.name = "rBG";
                        backRed.graphics.beginFill("rgba(191,33,47)").drawRect(0, 0, TBARH, TBARH);
                        backRed.x = startBackground + TBARH * 2;
                        backRed.on("mouseover", handleInteraction);
                        backRed.on("mouseout", handleInteraction);
                        backRed.alpha = 0.4;
                        backRed.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH * 2;
                            settings.selectedBackground = backRed;
                            settings.selectedBackgroundSer = "red";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backRed);

                        var backGreen = new createjs.Shape();
                        backGreen.name = "gBG";
                        backGreen.graphics.beginFill("rgba(0,111,60)").drawRect(0, 0, TBARH, TBARH);
                        backGreen.x = startBackground + TBARH * 3;
                        backGreen.on("mouseover", handleInteraction);
                        backGreen.on("mouseout", handleInteraction);
                        backGreen.alpha = 0.4;
                        backGreen.addEventListener('mousedown', function(event) {
                            event.nativeEvent.preventDefault();
                            backRect.x = startBackground + TBARH * 3;
                            settings.selectedBackground = backGreen;
                            settings.selectedBackgroundSer = "green";
                            applyToolbarSettings();
                        }, false);
                        toolbar.addChild(backGreen);

                        var backc = new createjs.Shape();
                        backc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH * 4, TBARH);
                        backc.x = startBackground;
                        toolbar.addChild(backc);

                        var startDownload = startBackground + 4 * TBARH;

                        var download = queue.getResult("download");
                        var downloadB = new createjs.Bitmap(download);
                        downloadB.scale = Math.floor(TBARH / downloadB.getBounds().height * 100)/100;
                        downloadB.x = startDownload + TBARH / 2 - (downloadB.getBounds().width * downloadB.scale / 2);
                        downloadB.y = TBARH / 2 - (downloadB.getBounds().height * downloadB.scale / 2);
                        downloadB.hitArea = hit;
                        downloadB.addEventListener('pressup', function(event) {
                            exportJpeg();
                        }, false);
                        toolbar.addChild(downloadB);

                        var downc = new createjs.Shape();
                        downc.graphics.beginStroke("rgba(100,100,100,0.8)").drawRect(0, 0, TBARH, TBARH);
                        downc.x = startDownload;
                        toolbar.addChild(downc);

                        toolbar.update();

                        applyToolbarSettings();
                        DrawMap();
                    });

                    queue.loadFile({src:"mappaCLAN.jpg", id:"clan"});
                    queue.loadFile({src:"mappaVICINI.jpg", id:"vicini"});
                    queue.loadFile({src:"shield.png", id:"scudo"});
                    queue.loadFile({src:"forbidden.png", id:"divieto"});
                    queue.loadFile({src:"download.png", id:"download"});

                }, 100);
                
            });

            function DrawMap() {
                stage.removeAllChildren();

                SCALE = Math.floor(H / clanMap.getBounds().height * 100)/100;
                MAPW = clanMap.getBounds().width * SCALE;

                W = MAPW * settings.maps;
                $("#canvas").width(W + "px").attr("width", W);

                mapsLayout = [];
                for (var m = 0; m < settings.maps; m++) {
                    var mapLayout = JSON.parse(JSON.stringify(mapSlots));
                    mapsLayout.push(mapLayout);
                }

                var sideMaps = Math.floor(settings.maps / 2);

                clanMap.scale = SCALE;
                clanMap.x = sideMaps * MAPW;

                for (var i = 0; i < sideMaps; i++) {
                    var map1 = neighbourMap.clone();
                    map1.scale = SCALE;
                    map1.x = i * MAPW;
                    stage.addChild(map1);
                }

                stage.addChild(clanMap);
                
                for (var i = 0; i < sideMaps; i++) {
                    var map2 = neighbourMap.clone();
                    map2.scale = SCALE;
                    map2.x = clanMap.x + ((i + 1) * MAPW);
                    stage.addChild(map2);
                }

                stage.addEventListener('mousedown', function(event) {
                        console.log("down");
                        cellPress(event.stageX, event.stageY);
                    }, false);
                
                stage.addEventListener('pressmove', function(event) {
                        console.log("move");
                        if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                            console.log("pressed");
                            cellPress(event.stageX, event.stageY);
                        } 
                        if(lockScroll == true) event.nativeEvent.preventDefault();
                    }, false);

                stage.addEventListener('pressup', function(event) {
                        console.log("release lock");
                        lockScroll = false;
                    }, false);

                for (var m = 0; m < mapsLayout.length; m++) {
                    var mapLayout = mapsLayout[m];
                    for (var x = 0; x < mapLayout.length; x++) {
                        var row = mapLayout[x];
                        for (var y = 0; y < row.length; y++) {
                            if (row[y].drawable) {
                                if (row[y].background) 
                                    stage.addChild(row[y].background);
                                if (row[y].symbol) 
                                    stage.addChild(row[y].symbol);
                            }
                        }
                    }
                }

                stage.update();
            }

            function exportJpeg() {
                let downloadLink = document.createElement('a');
                downloadLink.setAttribute('download', 'WarMap.png');
                let canvas = document.getElementById('canvas');
                let dataURL = canvas.toDataURL('image/png');
                let url = dataURL.replace(/^data:image\/png/,'data:application/octet-stream');
                downloadLink.setAttribute('href', url);
                downloadLink.click();
            }

            function cellPress(stageX, stageY) {
                var m = Math.floor(stageX / MAPW);
                var x = (stageX - m * MAPW) / SCALE;
                var y = stageY / SCALE;
                var row = Math.floor(y / 208);
                var column = Math.floor(x / 208);
                var cell = mapsLayout[m][row][column];
                if (!cell) return;
                if (cell.drawable) {
                    console.log("acquire lock");
                    lockScroll = true;
                    if (cell.symbol) stage.removeChild(cell.symbol);
                    if (cell.background) stage.removeChild(cell.background);

                    if (settings.selectedBackground == null) {
                        cell.background = null;
                        cell.backgroundSer = null;
                    }
                    else {
                        cell.background = settings.selectedBackground.clone();
                        cell.backgroundSet = settings.selectedBackgroundSer;
                        cell.background.alpha = 0.6;
                        cell.background.scale = Math.floor((208 * window.devicePixelRatio * SCALE) / TBARH  * 100)/100;
                        cell.background.x = m * MAPW + column * 208 * SCALE;
                        cell.background.y = row * 208 * SCALE;

                        cell.background.addEventListener('pressmove', function(event) {
                            if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                console.log("pressed");
                                cellPress(event.stageX, event.stageY);
                            } 
                            if(lockScroll == true) event.nativeEvent.preventDefault();
                            }, false);

                        stage.addChild(cell.background);
                    }
                    
                    if (settings.selectedShield == null) {
                        cell.symbol = null;
                        cell.symbolSer = null;
                    }
                    else {
                        cell.symbol = new createjs.Bitmap(settings.selectedShield.cacheCanvas);
                        cell.symbolSer = settings.selectedShield.symbolSer;
                        cell.symbol.scale = Math.floor((150 * window.devicePixelRatio * SCALE) / TBARH  * 100)/100;
                        cell.symbol.x = m * MAPW + column * 208 * SCALE + 25 * SCALE;
                        cell.symbol.y = row * 208 * SCALE + 25 * SCALE;
                        cell.symbol.addEventListener('pressmove', function(event) {
                            if(event.nativeEvent.buttons == 1 || event.nativeEvent.type == "touchmove") {
                                console.log("pressed");
                                cellPress(event.stageX, event.stageY);
                            } 
                            if(lockScroll == true) event.nativeEvent.preventDefault();
                            }, false);
                        stage.addChild(cell.symbol);
                    }
                    stage.update();
                }
            }

        </script>
    </body>
</html>


